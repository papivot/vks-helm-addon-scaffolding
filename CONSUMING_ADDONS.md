# Consuming VKS Addons

This guide explains how to consume the addons generated by the VKS Addon Management Repository scripts. When you run `vks-helm-fling-step1.sh`, it generates two template files in the package directory:

1.  `AddonInstall-template.yml`
2.  `AddonConfig-template.yml`

These files are used to deploy the addon to a VKS cluster (Tanzu Kubernetes Grid cluster managed by vSphere with Tanzu).

## Prerequisites

*   Access to the Supervisor Cluster (Management Cluster).
*   `kubectl` installed and configured.
*   A target VKS cluster (Guest Cluster) where you want to install the addon.

## Step 1: Customize AddonInstall

The `AddonInstall` resource defines *which* addon to install and *where* (on which clusters).

Open `AddonInstall-template.yml` and modify the following fields:

*   **`metadata.namespace`**: Set this to the namespace where your VKS cluster resides.
*   **`spec.clusters.selector.matchLabels`**: Update the label selector to target your specific cluster(s). Typically, `cluster.x-k8s.io/cluster-name: <YOUR_CLUSTER_NAME>` is used to target a single cluster.

**Example:**

```yaml
apiVersion: addons.kubernetes.vmware.com/v1alpha1
kind: AddonInstall
metadata:
  name: cluster-headlamp
  namespace: demo-namespace  # <--- Replace NAMESPACE_PLACEHOLDER
spec:
  addonRef:
    name: headlamp
    namespace: vmware-system-vks-public
  clusters:
  - selector:
      matchLabels:
        cluster.x-k8s.io/cluster-name: my-vks-cluster # <--- Replace CLUSTER_NAME_PLACEHOLDER
  crossNamespaceSelection: Blocked
  stopMatchingBehavior: Delete
```

## Step 2: Customize AddonConfig

The `AddonConfig` resource provides the configuration values for the addon (similar to `helm values.yaml`).

Open `AddonConfig-template.yml` and modify the following fields:

*   **`metadata.namespace`**: Set this to the namespace where your VKS cluster resides.
*   **`metadata.name`**: Update the name to include your cluster name (e.g., `my-vks-cluster-headlamp`).
*   **`spec.clusterName`**: Set this to the name of your VKS cluster.
*   **`spec.values`**: Update the values as needed. These are the Helm values for the chart.

**Example:**

```yaml
apiVersion: addons.kubernetes.vmware.com/v1alpha1
kind: AddonConfig
metadata:
  annotations:
    clusteraddon.addons.kubernetes.vmware.com/owned-for-deletion: "true"
  name: my-vks-cluster-headlamp # <--- Replace CLUSTER_NAME_PLACEHOLDER
  namespace: demo-namespace       # <--- Replace NAMESPACE_PLACEHOLDER
spec:
  addonConfigDefinitionRef:
    name: headlamp.vsphere.fling.vmware.com.0.39.0
    namespace: vmware-system-vks-public
  clusterName: my-vks-cluster     # <--- Replace CLUSTER_NAME_PLACEHOLDER
  values:
    service:
      type: LoadBalancer
    ingress:
      enabled: false
```

## Step 3: Apply the Manifests

Once customized, apply the files to the Supervisor Cluster:

```bash
kubectl apply -f AddonInstall-template.yml
kubectl apply -f AddonConfig-template.yml
```

## Verification

To verify the installation, check the status of the `Addon` resource on the Supervisor Cluster. You can also connect to the target VKS cluster and verify that the resources (Deployments, Services, etc.) have been created.
